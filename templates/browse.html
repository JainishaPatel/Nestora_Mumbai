{% extends "base.html" %}

{% block title %}Browse Houses | Nestora Mumbai{% endblock %}

{% block content %}

<!-- PAGE HEADER -->
<section class="py-4 bg-light">
    <div class="container">
        <h2 class="fw-bold">Browse Houses in Mumbai</h2>
        <p class="text-muted">Explore verified homes across Mumbai</p>
    </div>
</section>

<!-- FILTER BAR -->
<section class="py-3 border-bottom">
    <form action="{{ url_for('browse_houses') }}" method="get">
        <div class="container">
            <div class="row g-2">

                <input type="hidden" name="area" id="areaInput"
                    value="{{ request.args.get('area','') }}">

                <div class="dropdown col-md-6">
                    <button class="btn btn-outline-secondary w-100 dropdown-toggle"
                            type="button"
                            data-bs-toggle="dropdown"
                            id="areaDropdownBtn">
                        {{ request.args.get('area', 'Select Area') }}
                    </button>

                    <div class="dropdown-menu p-3 area-dropdown">
                        <div class="row g-3">
                            {% for main_area, sub_areas in areas.items() %}
                                <div class="col-6 col-md-4">
                                    <strong class="text-primary d-block mb-2">
                                        {{ main_area }}
                                    </strong>

                                    {% for sub_area in sub_areas %}
                                        <div class="form-check">
                                            <input class="form-check-input area-radio"
                                                type="radio"
                                                name="area_radio"
                                                value="{{ sub_area }}"
                                                id="area-{{ sub_area }}"
                                                {% if request.args.get('area') == sub_area %}checked{% endif %}>
                                            <label class="form-check-label"
                                                for="area-{{ sub_area }}">
                                                {{ sub_area }}
                                            </label>
                                        </div>
                                    {% endfor %}
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>


                <!-- Rent / Buy -->
                <div class="col-md-2">
                    <select class="form-select" name="property_type">
                        <option value="">All</option>

                        <option value="Rent" {% if request.args.get('property_type') == 'Rent' %}selected{% endif %}>
                        Rent</option>

                        <option value="Buy" {% if request.args.get('property_type') == 'Buy' %}selected{% endif %}>
                        Buy</option>
                    </select>
                </div>

                <!-- Budget -->
                <div class="col-md-3">
                    <input class="form-control"
                        name="max_price"
                        placeholder="Max Budget ₹"
                         value="{{ request.args.get('max_price','') }}">
                </div>

                <!-- Apply -->
                <div class="col-md-1">
                    <button class="btn btn-primary w-100">
                        <i class="fa-solid fa-magnifying-glass"></i>
                    </button>
                </div>

            </div>
        </div>
    </form>
</section>


<!-- LISTINGS -->
<section class="py-5">
    <div class="container">
        <div class="row g-4">
            {% for property in paginated_properties %}
                <div class="col-sm-6 col-md-4 col-lg-3">
                    <div class="card h-100 hover-card">
                        <img src="{{ property.cover_image() }}"
                            class="card-img-top"
                            alt="{{ property.title }}"
                            loading="lazy">
                        <div class="card-body">
                            <h5 class="card-title">{{ property.area }} {{ property.direction }}</h5>
                            <p class="mb-1">
                                <i class="fa-solid fa-indian-rupee-sign"></i>{{ property.formatted_price }} / {{ property.price_type }}
                            </p>
                            <p class="text-muted">
                                <i class="fa-solid fa-bed"></i> {{ property.bhk }} · {{ property.furnishing }}
                            </p>
                            <a href="{{ url_for('property_details', id=property.id) }}" class="btn btn-primary btn-sm w-100">
                                View Details
                            </a>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>
</section>

<!-- PAGINATION -->
<nav class="mt-4">
    <ul class="pagination justify-content-center">

        {# ===== Previous Button ===== #}
        <li class="page-item {% if page == 1 %}disabled{% endif %}">
            <a class="page-link"
               href="?page={{ page - 1 }}{% if area %}&area={{ area }}{% endif %}{% if property_type %}&property_type={{ property_type }}{% endif %}{% if max_price %}&max_price={{ max_price }}{% endif %}">
                &lt;
            </a>
        </li>

        {# ===== Page Numbers (window of 5) ===== #}
        {% set start = page - 2 if page - 2 > 1 else 1 %}
        {% set end = page + 2 if page + 2 < total_pages else total_pages %}

        {% for p in range(start, end + 1) %}
            <li class="page-item {% if p == page %}active{% endif %}">
                <a class="page-link"
                   href="?page={{ p }}{% if area %}&area={{ area }}{% endif %}{% if property_type %}&property_type={{ property_type }}{% endif %}{% if max_price %}&max_price={{ max_price }}{% endif %}">
                    {{ p }}
                </a>
            </li>
        {% endfor %}

        {# ===== Next Button ===== #}
        <li class="page-item {% if page == total_pages %}disabled{% endif %}">
            <a class="page-link"
               href="?page={{ page + 1 }}{% if area %}&area={{ area }}{% endif %}{% if property_type %}&property_type={{ property_type }}{% endif %}{% if max_price %}&max_price={{ max_price }}{% endif %}">
                &gt;
            </a>
        </li>

    </ul>
</nav>

{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/browse.js') }}"></script>
{% endblock %}
